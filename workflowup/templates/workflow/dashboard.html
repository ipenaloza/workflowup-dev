{% extends "base_authenticated.html" %}

{% block title %}Dashboard Administrador - WorkflowUp{% endblock %}

{% block content %}
<div class="bg-white rounded-lg shadow-md p-8">
    <h2 class="text-3xl font-bold text-gray-800 mb-6">
        Dashboard de Reportería - Administrador
    </h2>

    <!-- Section 1: Summary Cards -->
    <div class="mb-8">
        <h3 class="text-xl font-semibold text-gray-700 mb-4">Resumen de Workflows</h3>
        <div class="grid grid-cols-1 md:grid-cols-5 gap-4" id="summary-cards">
            <!-- Total Workflows -->
            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 shadow-sm">
                <div class="text-sm font-medium text-blue-600 mb-1">Total Workflows</div>
                <div class="text-3xl font-bold text-blue-700" id="stat-total">{{ stats.total }}</div>
            </div>

            <!-- Nuevo -->
            <div class="bg-gray-50 border border-gray-200 rounded-lg p-4 shadow-sm">
                <div class="text-sm font-medium text-gray-600 mb-1">Nuevos</div>
                <div class="text-3xl font-bold text-gray-700" id="stat-nuevo">{{ stats.nuevo }}</div>
            </div>

            <!-- Activo -->
            <div class="bg-green-50 border border-green-200 rounded-lg p-4 shadow-sm">
                <div class="text-sm font-medium text-green-600 mb-1">Activos</div>
                <div class="text-3xl font-bold text-green-700" id="stat-activo">{{ stats.activo }}</div>
            </div>

            <!-- Cerrado -->
            <div class="bg-indigo-50 border border-indigo-200 rounded-lg p-4 shadow-sm">
                <div class="text-sm font-medium text-indigo-600 mb-1">Cerrados</div>
                <div class="text-3xl font-bold text-indigo-700" id="stat-cerrado">{{ stats.cerrado }}</div>
            </div>

            <!-- Cancelado -->
            <div class="bg-red-50 border border-red-200 rounded-lg p-4 shadow-sm">
                <div class="text-sm font-medium text-red-600 mb-1">Cancelados</div>
                <div class="text-3xl font-bold text-red-700" id="stat-cancelado">{{ stats.cancelado }}</div>
            </div>
        </div>
    </div>

    <!-- Section 2: Process/State Matrix -->
    <div class="mb-8">
        <h3 class="text-xl font-semibold text-gray-700 mb-4">Matriz Proceso/Estado</h3>
        <div class="overflow-x-auto">
            <table class="min-w-full bg-white border border-gray-300 rounded-lg" id="process-matrix">
                <thead>
                    <tr class="bg-gray-100 border-b border-gray-300">
                        <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Proceso</th>
                        <th class="px-4 py-3 text-center text-sm font-semibold text-gray-700">En Proceso</th>
                        <th class="px-4 py-3 text-center text-sm font-semibold text-gray-700">Ok</th>
                        <th class="px-4 py-3 text-center text-sm font-semibold text-gray-700">No Ok</th>
                    </tr>
                </thead>
                <tbody>
                    {% for row in matrix_rows %}
                    <tr class="border-b border-gray-200 {% cycle 'bg-white' 'bg-gray-50' %}">
                        <td class="px-4 py-3 text-sm font-medium text-gray-700">{{ row.label }}</td>
                        <td class="px-4 py-3 text-center text-sm text-gray-600" id="matrix-{{ row.proceso|slugify }}-enproceso">{{ row.en_proceso }}</td>
                        <td class="px-4 py-3 text-center text-sm text-gray-600" id="matrix-{{ row.proceso|slugify }}-ok">{{ row.ok }}</td>
                        <td class="px-4 py-3 text-center text-sm text-gray-600" id="matrix-{{ row.proceso|slugify }}-nook">{{ row.no_ok }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Section 3: Filters and Detailed List -->
    <div>
        <h3 class="text-xl font-semibold text-gray-700 mb-4">Lista Detallada de Workflows</h3>

        <!-- Filter Panel -->
        <div class="bg-gray-50 border border-gray-200 rounded-lg p-6 mb-6">
            <h4 class="text-lg font-medium text-gray-700 mb-4">Filtros</h4>
            <form id="filter-form" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                <!-- Date Range -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Fecha Desde</label>
                    <input type="date" name="fecha_desde" id="fecha_desde" value="{{ filter_fecha_desde }}"
                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Fecha Hasta</label>
                    <input type="date" name="fecha_hasta" id="fecha_hasta" value="{{ filter_fecha_hasta }}"
                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>

                <!-- Estado Workflow -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Estado Workflow</label>
                    <select name="estado" id="estado"
                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">Todos</option>
                        <option value="Nuevo" {% if filter_estado == 'Nuevo' %}selected{% endif %}>Nuevo</option>
                        <option value="Activo" {% if filter_estado == 'Activo' %}selected{% endif %}>Activo</option>
                        <option value="Cerrado" {% if filter_estado == 'Cerrado' %}selected{% endif %}>Cerrado</option>
                        <option value="Cancelado" {% if filter_estado == 'Cancelado' %}selected{% endif %}>Cancelado</option>
                    </select>
                </div>

                <!-- Usuario -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Usuario</label>
                    <select name="usuario" id="usuario"
                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">Todos</option>
                        {% for usr in usuarios %}
                        <option value="{{ usr }}" {% if filter_usuario == usr %}selected{% endif %}>{{ usr }}</option>
                        {% endfor %}
                    </select>
                </div>

                <!-- ID Proyecto -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">ID Proyecto</label>
                    <input type="text" name="id_proyecto" id="id_proyecto" value="{{ filter_id_proyecto }}"
                           placeholder="Buscar..."
                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>

                <!-- Nombre Proyecto -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Nombre Proyecto</label>
                    <input type="text" name="nom_proyecto" id="nom_proyecto" value="{{ filter_nom_proyecto }}"
                           placeholder="Buscar..."
                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>

                <!-- Componente -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Componente</label>
                    <input type="text" name="componente" id="componente" value="{{ filter_componente }}"
                           placeholder="Buscar..."
                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>

                <!-- Buttons -->
                <div class="flex items-end space-x-2">
                    <button type="button" id="apply-filters"
                            class="flex-1 bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        Aplicar Filtros
                    </button>
                    <button type="button" id="clear-filters"
                            class="flex-1 bg-gray-500 text-white px-4 py-2 rounded-md hover:bg-gray-600 transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-gray-500">
                        Limpiar
                    </button>
                </div>
            </form>
        </div>

        <!-- Export Button -->
        <div class="mb-4 flex justify-end">
            <a href="#" id="export-csv"
               class="bg-green-600 text-white px-6 py-2 rounded-md hover:bg-green-700 transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-green-500 inline-flex items-center">
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                </svg>
                Exportar CSV
            </a>
        </div>

        <!-- Loading Indicator -->
        <div id="loading-indicator" class="hidden text-center py-4">
            <div class="inline-block animate-spin rounded-full h-8 w-8 border-4 border-gray-300 border-t-blue-600"></div>
            <p class="text-gray-600 mt-2">Cargando datos...</p>
        </div>

        <!-- Detailed Table -->
        <div class="overflow-x-auto">
            <table class="min-w-full bg-white border border-gray-300 rounded-lg" id="workflows-table">
                <thead>
                    <tr class="bg-gray-100 border-b border-gray-300">
                        <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">ID Workflow</th>
                        <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Proyecto</th>
                        <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Componente</th>
                        <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">ID Proyecto</th>
                        <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Estado Workflow</th>
                        <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Proceso</th>
                        <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Estado Proceso</th>
                        <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Usuario</th>
                        <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Fecha</th>
                        <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Comentario</th>
                    </tr>
                </thead>
                <tbody id="workflows-tbody">
                    {% for detail in workflow_details %}
                    <tr class="border-b border-gray-200 {% cycle 'bg-white' 'bg-gray-50' %}">
                        <td class="px-4 py-3 text-sm text-gray-700">{{ detail.id_workflow }}</td>
                        <td class="px-4 py-3 text-sm text-gray-700">{{ detail.nom_proyecto }}</td>
                        <td class="px-4 py-3 text-sm text-gray-700">{{ detail.componente }}</td>
                        <td class="px-4 py-3 text-sm text-gray-700">{{ detail.id_proyecto }}</td>
                        <td class="px-4 py-3 text-sm">
                            <span class="px-2 py-1 rounded-full text-xs font-medium
                                {% if detail.estado_workflow == 'Nuevo' %}bg-gray-200 text-gray-700
                                {% elif detail.estado_workflow == 'Activo' %}bg-green-200 text-green-700
                                {% elif detail.estado_workflow == 'Cerrado' %}bg-indigo-200 text-indigo-700
                                {% elif detail.estado_workflow == 'Cancelado' %}bg-red-200 text-red-700
                                {% endif %}">
                                {{ detail.estado_workflow }}
                            </span>
                        </td>
                        <td class="px-4 py-3 text-sm text-gray-700">{{ detail.proceso }}</td>
                        <td class="px-4 py-3 text-sm">
                            <span class="px-2 py-1 rounded-full text-xs font-medium
                                {% if detail.estado_proceso == 'En Proceso' %}bg-yellow-200 text-yellow-700
                                {% elif detail.estado_proceso == 'Ok' %}bg-green-200 text-green-700
                                {% elif detail.estado_proceso == 'No Ok' %}bg-red-200 text-red-700
                                {% else %}bg-gray-200 text-gray-700
                                {% endif %}">
                                {{ detail.estado_proceso }}
                            </span>
                        </td>
                        <td class="px-4 py-3 text-sm text-gray-700">{{ detail.usuario }}</td>
                        <td class="px-4 py-3 text-sm text-gray-700">{{ detail.fecha|date:"Y-m-d H:i:s" }}</td>
                        <td class="px-4 py-3 text-sm text-gray-700">{{ detail.comentario|truncatewords:10 }}</td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="10" class="px-4 py-6 text-center text-gray-500">
                            No hay workflows que coincidan con los filtros aplicados.
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Results Count -->
        <div class="mt-4 text-sm text-gray-600">
            <span id="total-count" class="font-semibold">{{ workflow_details|length }}</span> registros (actividades históricas)
        </div>
    </div>
</div>

<!-- JavaScript for AJAX functionality -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const applyFiltersBtn = document.getElementById('apply-filters');
    const clearFiltersBtn = document.getElementById('clear-filters');
    const exportCsvBtn = document.getElementById('export-csv');
    const loadingIndicator = document.getElementById('loading-indicator');
    const workflowsTable = document.getElementById('workflows-table');

    // Get CSRF token
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    const csrftoken = getCookie('csrftoken');

    // Apply filters
    applyFiltersBtn.addEventListener('click', function() {
        const formData = new FormData(document.getElementById('filter-form'));
        const params = new URLSearchParams(formData);

        // Show loading indicator
        loadingIndicator.classList.remove('hidden');
        workflowsTable.classList.add('opacity-50');

        // Make AJAX request
        fetch('{% url "workflow:dashboard_api" %}?' + params.toString(), {
            method: 'GET',
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Update statistics cards
                document.getElementById('stat-total').textContent = data.stats.total;
                document.getElementById('stat-nuevo').textContent = data.stats.nuevo;
                document.getElementById('stat-activo').textContent = data.stats.activo;
                document.getElementById('stat-cerrado').textContent = data.stats.cerrado;
                document.getElementById('stat-cancelado').textContent = data.stats.cancelado;

                // Update matrix
                document.getElementById('matrix-linea-base-enproceso').textContent = data.matrix['linea base']['En Proceso'];
                document.getElementById('matrix-linea-base-ok').textContent = data.matrix['linea base']['Ok'];
                document.getElementById('matrix-linea-base-nook').textContent = data.matrix['linea base']['No Ok'];
                document.getElementById('matrix-rm-rev-enproceso').textContent = data.matrix['RM Rev']['En Proceso'];
                document.getElementById('matrix-rm-rev-ok').textContent = data.matrix['RM Rev']['Ok'];
                document.getElementById('matrix-rm-rev-nook').textContent = data.matrix['RM Rev']['No Ok'];
                document.getElementById('matrix-diff-info-enproceso').textContent = data.matrix['Diff Info']['En Proceso'];
                document.getElementById('matrix-diff-info-ok').textContent = data.matrix['Diff Info']['Ok'];
                document.getElementById('matrix-diff-info-nook').textContent = data.matrix['Diff Info']['No Ok'];
                document.getElementById('matrix-qa-enproceso').textContent = data.matrix['QA']['En Proceso'];
                document.getElementById('matrix-qa-ok').textContent = data.matrix['QA']['Ok'];
                document.getElementById('matrix-qa-nook').textContent = data.matrix['QA']['No Ok'];

                // Update table
                const tbody = document.getElementById('workflows-tbody');
                tbody.innerHTML = '';

                if (data.workflow_details.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="10" class="px-4 py-6 text-center text-gray-500">No hay workflows que coincidan con los filtros aplicados.</td></tr>';
                } else {
                    data.workflow_details.forEach((detail, index) => {
                        const row = document.createElement('tr');
                        row.className = 'border-b border-gray-200 ' + (index % 2 === 0 ? 'bg-white' : 'bg-gray-50');

                        // Estado Workflow badge class
                        let estadoWorkflowClass = 'bg-gray-200 text-gray-700';
                        if (detail.estado_workflow === 'Nuevo') estadoWorkflowClass = 'bg-gray-200 text-gray-700';
                        else if (detail.estado_workflow === 'Activo') estadoWorkflowClass = 'bg-green-200 text-green-700';
                        else if (detail.estado_workflow === 'Cerrado') estadoWorkflowClass = 'bg-indigo-200 text-indigo-700';
                        else if (detail.estado_workflow === 'Cancelado') estadoWorkflowClass = 'bg-red-200 text-red-700';

                        // Estado Proceso badge class
                        let estadoProcesoClass = 'bg-gray-200 text-gray-700';
                        if (detail.estado_proceso === 'En Proceso') estadoProcesoClass = 'bg-yellow-200 text-yellow-700';
                        else if (detail.estado_proceso === 'Ok') estadoProcesoClass = 'bg-green-200 text-green-700';
                        else if (detail.estado_proceso === 'No Ok') estadoProcesoClass = 'bg-red-200 text-red-700';

                        row.innerHTML = `
                            <td class="px-4 py-3 text-sm text-gray-700">${detail.id_workflow}</td>
                            <td class="px-4 py-3 text-sm text-gray-700">${detail.nom_proyecto}</td>
                            <td class="px-4 py-3 text-sm text-gray-700">${detail.componente}</td>
                            <td class="px-4 py-3 text-sm text-gray-700">${detail.id_proyecto}</td>
                            <td class="px-4 py-3 text-sm">
                                <span class="px-2 py-1 rounded-full text-xs font-medium ${estadoWorkflowClass}">
                                    ${detail.estado_workflow}
                                </span>
                            </td>
                            <td class="px-4 py-3 text-sm text-gray-700">${detail.proceso}</td>
                            <td class="px-4 py-3 text-sm">
                                <span class="px-2 py-1 rounded-full text-xs font-medium ${estadoProcesoClass}">
                                    ${detail.estado_proceso}
                                </span>
                            </td>
                            <td class="px-4 py-3 text-sm text-gray-700">${detail.usuario}</td>
                            <td class="px-4 py-3 text-sm text-gray-700">${detail.fecha}</td>
                            <td class="px-4 py-3 text-sm text-gray-700">${detail.comentario}</td>
                        `;
                        tbody.appendChild(row);
                    });
                }

                // Update count with clarification
                document.getElementById('total-count').textContent = data.workflow_details.length;

                // Hide loading indicator
                loadingIndicator.classList.add('hidden');
                workflowsTable.classList.remove('opacity-50');
            } else {
                alert('Error: ' + data.error);
                loadingIndicator.classList.add('hidden');
                workflowsTable.classList.remove('opacity-50');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error al cargar los datos. Por favor, intente nuevamente.');
            loadingIndicator.classList.add('hidden');
            workflowsTable.classList.remove('opacity-50');
        });
    });

    // Clear filters
    clearFiltersBtn.addEventListener('click', function() {
        document.getElementById('filter-form').reset();
        // Trigger apply filters with empty form
        applyFiltersBtn.click();
    });

    // Export CSV
    exportCsvBtn.addEventListener('click', function(e) {
        e.preventDefault();
        const formData = new FormData(document.getElementById('filter-form'));
        const params = new URLSearchParams(formData);
        window.location.href = '{% url "workflow:export_workflows_csv" %}?' + params.toString();
    });
});
</script>
{% endblock %}
