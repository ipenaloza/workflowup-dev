{% extends "base_authenticated.html" %}

{% block title %}Workflow - WorkflowUp{% endblock %}

{% block content %}
<div class="bg-white rounded-lg shadow-md p-8">
    <div class="flex justify-between items-center mb-6">
        <h2 class="text-3xl font-bold text-gray-800">
            Listado de Workflows - {{ user.first_name }} {{ user.last_name }}
        </h2>
        <a href="{% url 'workflow:workflow_create' %}"
           class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded transition-colors duration-200">
            Crear Workflow
        </a>
    </div>

    <!-- Filtros -->
    <div class="bg-gray-50 rounded-lg p-6 mb-6">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-semibold text-gray-800">Filtros de Búsqueda</h3>
            {% if request.GET.id_proyecto or request.GET.estado or request.GET.fecha_desde or request.GET.fecha_hasta %}
            <span class="bg-blue-100 text-blue-800 text-xs font-medium px-2.5 py-0.5 rounded">
                Filtros activos
            </span>
            {% endif %}
        </div>
        <form method="get" action="{% url 'workflow:dashboard' %}" class="space-y-4">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                <!-- Filtro por ID Proyecto -->
                <div>
                    <label for="id_proyecto" class="block text-sm font-medium text-gray-700 mb-1">ID Proyecto</label>
                    <select name="id_proyecto"
                            id="id_proyecto"
                            class="w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 text-sm">
                        <option value="">Todos los proyectos</option>
                        {% for project_id in project_ids %}
                        <option value="{{ project_id }}" {% if request.GET.id_proyecto == project_id %}selected{% endif %}>
                            {{ project_id }}
                        </option>
                        {% endfor %}
                    </select>
                </div>

                <!-- Filtro por Estado -->
                <div>
                    <label for="estado" class="block text-sm font-medium text-gray-700 mb-1">Estado</label>
                    <select name="estado"
                            id="estado"
                            class="w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 text-sm">
                        <option value="">Todos los estados</option>
                        <option value="Nuevo" {% if request.GET.estado == 'Nuevo' %}selected{% endif %}>Nuevo</option>
                        <option value="Activo" {% if request.GET.estado == 'Activo' %}selected{% endif %}>Activo</option>
                    </select>
                </div>

                <!-- Filtro por Fecha Desde -->
                <div>
                    <label for="fecha_desde" class="block text-sm font-medium text-gray-700 mb-1">Fecha Creación Desde</label>
                    <input type="date"
                           name="fecha_desde"
                           id="fecha_desde"
                           value="{{ request.GET.fecha_desde }}"
                           class="w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 text-sm">
                </div>

                <!-- Filtro por Fecha Hasta -->
                <div>
                    <label for="fecha_hasta" class="block text-sm font-medium text-gray-700 mb-1">Fecha Creación Hasta</label>
                    <input type="date"
                           name="fecha_hasta"
                           id="fecha_hasta"
                           value="{{ request.GET.fecha_hasta }}"
                           class="w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 text-sm">
                </div>
            </div>

            <!-- Botones de acción -->
            <div class="flex space-x-2">
                <button type="submit"
                        class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded transition-colors duration-200">
                    Aplicar Filtros
                </button>
                <a href="{% url 'workflow:dashboard' %}"
                   class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded transition-colors duration-200">
                    Limpiar Filtros
                </a>
            </div>
        </form>
    </div>

    {% if workflow_data %}
    <!-- Contador de resultados -->
    <div class="mb-4">
        <p class="text-sm text-gray-600">
            Se encontraron <span class="font-semibold text-gray-900">{{ workflow_data|length }}</span> workflow{{ workflow_data|length|pluralize }}
            {% if request.GET.id_proyecto or request.GET.estado or request.GET.fecha_desde or request.GET.fecha_hasta %}
            con los filtros aplicados
            {% endif %}
        </p>
    </div>

    <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
                <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID Workflow</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID Proyecto</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nombre Proyecto</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Creación</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">QA Estimado</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">PAP Estimado</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Estado Workflow</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actividad</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Estado</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Acciones</th>
                </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
                {% for data in workflow_data %}
                <tr class="hover:bg-gray-50">
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                        {{ data.workflow.id_workflow }}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        {{ data.workflow.id_proyecto }}
                    </td>
                    <td class="px-6 py-4 text-sm text-gray-900">
                        {{ data.workflow.nom_proyecto }}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        {{ data.workflow.creacion|date:"d/m/Y" }}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        {{ data.workflow.qa_estimado|date:"d/m/Y" }}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        {{ data.workflow.pap_estimado|date:"d/m/Y" }}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full
                            {% if data.estado_workflow == 'Nuevo' %}bg-blue-100 text-blue-800
                            {% elif data.estado_workflow == 'Activo' %}bg-green-100 text-green-800
                            {% else %}bg-gray-100 text-gray-800{% endif %}">
                            {{ data.estado_workflow }}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        {{ data.proceso|default:"-" }}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        {{ data.estado_proceso|default:"-" }}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        <div class="flex space-x-2">
                            <a href="{% url 'workflow:workflow_detail' data.workflow.id_workflow %}"
                               class="text-blue-600 hover:text-blue-900">Ver Detalles</a>
                            <a href="{% url 'workflow:plan_pruebas' data.workflow.id_workflow %}"
                               class="text-green-600 hover:text-green-900">Plan de Pruebas</a>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <div class="text-center py-12">
        <p class="text-gray-500 text-lg mb-4">No hay workflows activos.</p>
        <a href="{% url 'workflow:workflow_create' %}"
           class="inline-block bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded transition-colors duration-200">
            Crear mi primer Workflow
        </a>
    </div>
    {% endif %}
</div>
{% endblock %}
